"""
Exploit validation (no exploitation)
MITRE: T1203
"""
import subprocess
from time import sleep
import tempfile
import os
import json

def ensure_msf_container(container_name="metasploit2",
                         image_name="metasploitframework/metasploit-framework"):
    """
    Assicura che il container Metasploit sia pronto.
    - Se non esiste → pull + create
    - Se fermo → start
    - Se running → ok
    """

    status = subprocess.run(
        f"docker ps -a --filter name={container_name} --format '{{{{.Status}}}}'",
        shell=True, capture_output=True, text=True
    ).stdout.strip()

    if "Up" in status:
        print(f"[INFO] Container '{container_name}' già in esecuzione.")
        return

    if "Exited" in status:
        print(f"[INFO] Avvio container '{container_name}' fermo…")
        subprocess.run(f"docker start {container_name}", shell=True)
        sleep(3)
        return

    print("[INFO] Container non trovato. Creo ambiente…")

    images = subprocess.run(
        f"docker images -q {image_name}",
        shell=True, capture_output=True, text=True
    ).stdout.strip()

    if not images:
        print(f"[INFO] Download immagine Docker {image_name}")
        subprocess.run(f"docker pull {image_name}", shell=True)

    print("[INFO] Avvio container Metasploit…")

    subprocess.run(
        f"docker run -d --name {container_name} "
        "--cap-add=NET_RAW --cap-add=NET_ADMIN --privileged "
        "-p 4444:4444 -p 55553:55553 "
        f"{image_name} tail -f /dev/null",
        shell=True
    )

    sleep(5)

def stop_msf_container(container_name="metasploit2"):
    """
    Stoppa e rimuove in sicurezza il container Metasploit.
    Non genera errore se non esiste.
    """
    # Se il container gira → stop
    subprocess.run(
        f"docker stop {container_name}",
        shell=True,
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE
    )

    # Se esiste → rimuovi
    subprocess.run(
        f"docker rm {container_name}",
        shell=True,
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE
    )

def metasploit_check(context):
    """
    exploits.metasploit_check
    Pipeline automatizzata:
    1. Esegue Nmap con script vulnerabilità
    2. Salva risultato in XML
    3. Importa in Metasploit
    4. Estrae CVE
    5. Cerca moduli Metasploit compatibili
    6. Esegue 'check' per ogni modulo
    7. Restituisce JSON report
    """

    ensure_msf_container(
        container_name="metasploit2",
        image_name="metasploitframework/metasploit-framework"
    )  # tua funzione già esistente

    try:
        gateways = context.network_gateways()
        if not gateways:
            return {
                "status": "error",
                "raw": "",
                "summary": "Nessun gateway definito"
            }

        target_ip = gateways[0]

        # ----------------------------------------
        # 1️⃣ Eseguiamo Nmap con vulners script
        # ----------------------------------------
        tmp_dir = tempfile.gettempdir()
        xml_path = os.path.join(tmp_dir, "msf_scan.xml")

        nmap_cmd = f"nmap -sT -sV --script vulners -oX {xml_path} {target_ip}"
        nmap_result = subprocess.run(nmap_cmd, shell=True, capture_output=True, text=True)

        if nmap_result.returncode != 0:
            return {
                "status": "error",
                "raw": nmap_result.stderr,
                "summary": "Errore durante Nmap"
            }

        # Copiamo XML dentro container metasploit
        subprocess.run(
            f"docker cp {xml_path} metasploit2:/tmp/msf_scan.xml",
            shell=True
        )

        # ----------------------------------------
        # 2️⃣ Importiamo in Metasploit e dump CVE
        # ----------------------------------------
        msf_script = r"""
            db_import /tmp/msf_scan.xml
            spool /tmp/msf_vuln.txt
            vulns
            spool off
            exit
        """

        with open("/tmp/msf_script.rc", "w") as f:
            f.write(msf_script)

        subprocess.run("docker cp /tmp/msf_script.rc metasploit2:/tmp/script.rc", shell=True)

        subprocess.run(
            "docker exec metasploit2 bash -lc \"./msfconsole -q -r /tmp/script.rc\"",
            shell=True,
            capture_output=True,
            text=True
        )

        # Recuperiamo vulnerabilità estratte
        subprocess.run(
            "docker cp metasploit2:/tmp/msf_vuln.txt /tmp/msf_vuln.txt",
            shell=True
        )

        # ----------------------------------------
        # 3️⃣ Parsing base CVE trovate
        # ----------------------------------------
        cve_list = []
        with open("/tmp/msf_vuln.txt", "r") as f:
            for line in f.readlines():
                if "CVE-" in line:
                    parts = line.strip().split()
                    for p in parts:
                        if "CVE-" in p:
                            cve_list.append(p.replace(",", "").strip())

        cve_list = list(set(cve_list))

        results = []

        # ----------------------------------------
        # 4️⃣ Per ogni CVE → cerchiamo modulo + check
        # ----------------------------------------
        for cve in cve_list:

            msf_dynamic = f"""
                search cve:{cve}
                spool /tmp/check_{cve}.txt
                use auxiliary/scanner/vuln/
                exit
            """
            # Nota: non possiamo sapere il modulo esatto qui senza parsing avanzato
            # quindi usiamo search e salviamo output

            with open("/tmp/tmpcmd.rc", "w") as f:
                f.write(msf_dynamic)

            subprocess.run("docker cp /tmp/tmpcmd.rc metasploit2:/tmp/tmpcmd.rc", shell=True)

            subprocess.run(
                "docker exec metasploit2 bash -lc \"./msfconsole -q -r /tmp/tmpcmd.rc\"",
                shell=True,
                capture_output=True
            )

            subprocess.run(
                f"docker cp metasploit2:/tmp/check_{cve}.txt /tmp/check_{cve}.txt",
                shell=True
            )

            with open(f"/tmp/check_{cve}.txt") as f:
                results.append({
                    "cve": cve,
                    "result": f.read()
                })

        report_json = json.dumps({
            "target": target_ip,
            "found_cves": cve_list,
            "checks": results
        }, indent=4)

        return {
            "status": "success",
            "raw": report_json,
            "summary": f"Metasploit vulnerability scan completato su {target_ip}"
        }
    finally:
        stop_msf_container(container_name="metasploit2")